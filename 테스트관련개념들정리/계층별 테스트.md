### 계층별 테스트

테스트 책을 보면 정말 많이 언급되는 이야기다. 각각의 기능의 경계를 명확하게 해둬야 한다고. 이런 이야기를 정말 자주 한다. 그래서 테스트가 가능한 코드를 작성한다는 것은 논리적으로 말을 한다는 것과 어느 정도는 상통하는 면이 있다.<br>

오늘 정리하는 내용은 스프링 쪽에서의 테스트 이야기다. Spring 쪽에서의 계층별 테스트는 보통 아래와 같이 수행한다.<br>

정답은 없다. 하지만 아래와 같이 할 때 유익한것 같다.



### Controller

> **참고\) 테스트 코드 작성 전 Controller 는 이렇게 작성되면 좋다.**<br>
>
> Controller 에서 비즈니스 로직을 수행하면 안된다. Controller 에서는 주어진 Request 에 대해 Service 가 어떤 결과를 내면 어떤 응답을 낼지, 파라미터의 값이 부정확하면 어떤 파라미터에 대해 어떤 예외를 낼지, 어떤 요청은 어디로 포워딩할지 등을 적는 편이다. 경험상 레거시가 심한 코드도 봤고, Controller 를 깔끔하게 구성한 코드도 봤다. Controller 계층을 깔끔하게 작성한 코드는 대부분 Controller 에서 비즈니스 로직 대신 Validation 을 명확하게 수행했었다.

- 파라미터 바인딩, 밸리데이션
  - e.g. password 는 알파벳 소문자, 대문자를 구별하며, 숫자는 두 글자 포함되어야 하고 특수문자를 한 글자 이상 포함해야 한다.
  - e.g. 상품 코드는 null 일 수 없다.
- 파라미터 바인딩, 벨리데이션이 틀릴 경우 예외가 적정한지를 테스트
  - e.g. page 번호가 음수일 경우 IllegalPageNumberException 을 낸다.
- Service 계층의 예외를 가정했을 때 RestControllerAdvice 를 통해 올바른 예외를 내는지를 가정
- 계속해서 추가

<br>



### Service

> **참고\) 테스트 코드 작성 전 Service 는 이렇게 작성되면 좋다.**<br>
>
> @Autowired 는 가급적 지양된 코드가 테스트에 용이하다. 
>
> 각각의 기능을 메서드 단위로 구분하고, 하나의 메서드가 여러 역할을 수행하지 않도록 구성한다.
>
> 공통된 내용은 추상화하고, 추상화 기반으로 다양해지는 것은 다형성으로 풀어낸다.
>
> 뭐지? 방금 뭐가 떠올랐다가 사라졌는데? 왜 기억이 안나지? 칼슘을 더 먹어야 하나??

<br>

- Repository 에 데이터를 저장할 때 트랜잭션 상에 예외가 있을 경우에 대한 처리
- 트랜잭션 처리 결과 테스트 코드
- 주요 체크 로직 테스트
- 세부적인 비즈니스 로직 테스트 코드
  - e.g. 회원 가입 시도 시 request history log 추가 
  - e.g. 주문 시도 시 주문 Requset history log 추가
  - e.g. ... 계속 추가
- 생성자 주입이 잘 지켜진다면 Spring 의 @MockBean 으로 주입 받을 경우도 있고 순수 Java 를 이용해 객체를 생성해 테스트를 해도 자유롭게 편리하게 테스트가 가능해진다.

<br>



### Repository, DAO, Mybatis, etc

> **참고\)테스트 코드 작성 전 Repository, DAO, Mybatis 는 이렇게 작성되면 좋다.**<br>
>
> 테스트 코드 작성 전에 Repository 계층의 코드를 작성할 때는 주어진 입력을 받아서 데이터를 조회해주는 원시적인 역할을 명확히 해야 한다. 그래야 Repository 계층의 테스트 경계가 명확해진다

<br>

- Profile 을 통해 Datasource 를 주입받아서 테스트
- 주로 h2 로 먼저 테스트를 수행한다. 그리고 나서 개발 DB에서도 정상적인지를 테스트한다.
- 예전에는 mybatis 는 h2 테스트가 쉽지 않았는데, 요즘은 너무 오래된 mybatis 버전이 아닌 이상 h2 를 데이터소스로 지정해서 테스트하는 것이 가능해짐
- Repository 에서 예외를 발생시키거나 데이터를 변환하고 이런 작업을 하면 어떤 계층에서 예외가 발생했는지 찾기 어려워지는 현상이 발생한다.
- 이런 경우 Service 계층에 팩토리 메서드 또는 Mapper 클래스 등을 별도로 두어서 데이터 계층의 엔티티를 Service 계층에 전달하는 DTO 를 만드는 역할의 메서드들을 따로 구현해둔다.

<br>

